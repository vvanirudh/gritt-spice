# Merge restack can continue from a conflict with 'gs continue'

as 'Test <test@example.com>'
at '2024-05-27T18:24:42Z'

mkdir repo
cd repo
git init
git add init.txt
git commit -m 'Initial commit'
gs repo init

# Configure merge-based restacking
git config spice.restack.method merge

# Create a feature branch that modifies init
cp $WORK/extra/init.feature.txt init.txt
git add init.txt
gs bc -m feature

# Go back to main and modify init (conflicting change)
gs trunk
cp $WORK/extra/init.new.txt init.txt
git add init.txt
git commit -m 'Change init'

gs up
stderr 'feature: needs to be restacked'

# Restack the feature branch - should hit conflict
! gs branch restack
stderr 'There was a conflict while merging'
stderr 'gs continue'
stderr 'gs abort'

# Resolve the conflict
cp $WORK/extra/init.resolved.txt init.txt
git add init.txt

# Continue the merge
env EDITOR=true
gs continue

# Verify state
cmp init.txt $WORK/extra/init.resolved.txt

# Verify merge commit was created
git log --oneline --graph feature
stdout 'Restack: merge base into feature'

gs trunk
cmp init.txt $WORK/extra/init.new.txt

-- repo/init.txt --
initial init

-- extra/init.new.txt --
changed init

-- extra/init.feature.txt --
feature's init

-- extra/init.resolved.txt --
updated init
