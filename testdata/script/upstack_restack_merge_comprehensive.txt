# Comprehensive test for upstack restack with merge method
# Tests that all branches in upstack use merge method consistently

as 'Test User <test@example.com>'
at 2025-06-20T21:28:29Z

cd repo
git init
git commit -m 'Initial commit' --allow-empty

# Set merge as the restack method
git config spice.restack.method merge

gs repo init

# Create a stack of 4 branches
git add feat1.txt
gs branch create feat1 -m 'feat1 commit'
git add feat2.txt
gs branch create feat2 -m 'feat2 commit'
git add feat3.txt
gs branch create feat3 -m 'feat3 commit'
git add feat4.txt
gs branch create feat4 -m 'feat4 commit'

# Move trunk forward to require restacking
gs branch checkout main
git add trunk-change.txt
git commit -m 'New trunk commit'

# First restack feat1 to make the upstack need restacking
gs branch checkout feat1
gs branch restack --method=merge

# Test: Upstack restack from middle of stack
gs branch checkout feat2
gs upstack restack --method=merge

# Verify all upstack branches were restacked with merge
git log --oneline feat2
stdout 'Restack feat2 onto feat1 via merge'
stdout 'feat2 commit'

git log --oneline feat3
stdout 'Restack feat3 onto feat2 via merge'
stdout 'feat3 commit'

git log --oneline feat4
stdout 'Restack feat4 onto feat3 via merge'
stdout 'feat4 commit'

# Verify all restacked branches have merge commits (2 parents)
git rev-list --parents feat2 -1
stdout '^[0-9a-f]+ [0-9a-f]+ [0-9a-f]+$'

git rev-list --parents feat3 -1
stdout '^[0-9a-f]+ [0-9a-f]+ [0-9a-f]+$'

git rev-list --parents feat4 -1
stdout '^[0-9a-f]+ [0-9a-f]+ [0-9a-f]+$'

# Test: Method consistency - no rebase operations should have occurred
git log --oneline --all --grep='rebase'
! stdout .

# Test: feat1 was restacked in setup but not by upstack command
git log --oneline feat1
stdout 'feat1 commit'

# Test: Skip start option
gs branch checkout main
git commit --allow-empty -m 'Another trunk commit'

gs branch checkout feat3
gs upstack restack --skip-start --method=merge

# Only feat4 should be restacked, not feat3
git log --oneline feat3
! stdout 'Another trunk commit'

git log --oneline feat4
stdout 'Restack feat4 onto feat3 via merge'

# Test: Method consistency with configuration override
git config spice.restack.method rebase
gs branch checkout main
git commit --allow-empty -m 'Third trunk commit'

# Should still use merge when explicitly specified
gs branch checkout feat1
gs upstack restack --method=merge

# Verify merge was used despite rebase config
git log --oneline feat2
stdout 'Restack feat2 onto feat1 via merge'

# Test: Verify upstack relationships are maintained correctly
gs log short
stderr 'feat4'
stderr 'feat3'
stderr 'feat2'
stderr 'feat1'
stderr 'main'

-- repo/feat1.txt --
feature 1
-- repo/feat2.txt --
feature 2
-- repo/feat3.txt --
feature 3
-- repo/feat4.txt --
feature 4
-- repo/trunk-change.txt --
trunk modification