# 'repo sync' respects spice.restack.method=merge configuration

as 'Test <test@example.com>'
at '2024-05-18T13:59:12Z'

# setup
cd repo
git init
git commit --allow-empty -m 'Initial commit'

# set up a fake GitHub remote
shamhub init
shamhub new origin alice/example.git
shamhub register alice
git push origin main

env SHAMHUB_USERNAME=alice
gs auth login

# configure to use merge for restacking
git config spice.restack.method merge

# create a stack
git add feature1.txt
gs bc -m 'Add feature1' feature1

git add feature2.txt
gs bc -m 'Add feature2' feature2

git add feature3.txt
gs bc -m 'Add feature3' feature3

# submit feature1
gs bco feature1
gs branch submit --fill
stderr 'Created #'

# merge the PR server side and sync with explicit restack
shamhub merge alice/example 1
gs repo sync --restack
stderr 'feature1: #1 was merged'

# verify the stack was restacked using merge method
git graph --branches
stdout 'Restack feature3 onto feature2 via merge'
stdout 'Restack feature2 onto main via merge'

# verify that feature2 and feature3 have merge commits (2 parents)
git rev-list --parents feature2 -1
stdout '^[0-9a-f]+ [0-9a-f]+ [0-9a-f]+$'

git rev-list --parents feature3 -1  
stdout '^[0-9a-f]+ [0-9a-f]+ [0-9a-f]+$'

-- repo/feature1.txt --
Contents of feature1

-- repo/feature2.txt --
Contents of feature2

-- repo/feature3.txt --
Contents of feature3