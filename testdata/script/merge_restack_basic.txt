# Basic merge restack functionality without conflicts
# Verifies that merge-based restacking creates merge commits

as 'Test User <test@example.com>'
at 2025-06-20T21:28:29Z

cd repo
git init
git commit -m 'Initial commit' --allow-empty

gs repo init
git add feat1.txt
gs branch create feat1 -m 'feat1 commit'
git add feat2.txt
gs branch create feat2 -m 'feat2 commit'

# Create a new commit on trunk to make branches need restacking
gs branch checkout main
git commit --allow-empty -m 'New trunk commit'

# Configure merge-based restacking
git config spice.restack.method merge

# Restack feat1
gs branch checkout feat1
gs branch restack
stderr 'feat1: restacked on main'

# Verify merge commit was created (not a rebase)
git log --oneline --graph feat1
stdout 'Restack: merge base into feat1'

# Restack feat2
gs branch checkout feat2
gs upstack restack
stderr 'feat2: restacked on feat1'

# Verify merge commits were created
git log --oneline --graph feat2
stdout 'Restack: merge base into feat2'

-- repo/feat1.txt --
feature 1
-- repo/feat2.txt --
feature 2
